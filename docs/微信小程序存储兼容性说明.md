# 微信小程序存储兼容性说明

## 概述

本项目已完全兼容微信小程序的本地存储机制，所有存储操作都使用uni-app的统一API，确保在微信小程序环境中正常运行。

## 存储实现

### 1. 基础存储工具 (`src/utils/storage.ts`)

所有存储操作都使用uni-app的存储API：

```typescript
// 存储数据
uni.setStorageSync(key, value)

// 获取数据
uni.getStorageSync(key)

// 删除数据
uni.removeStorageSync(key)

// 清空所有数据
uni.clearStorageSync()

// 获取存储信息
uni.getStorageInfoSync()
```

### 2. Pinia持久化配置 (`src/stores/index.ts`)

配置了pinia持久化插件使用uni-app存储API：

```typescript
pinia.use(piniaPluginPersistedstate({
  storage: {
    getItem: (key: string) => uni.getStorageSync(key),
    setItem: (key: string, value: any) => uni.setStorageSync(key, value),
    removeItem: (key: string) => uni.removeStorageSync(key)
  }
}))
```

### 3. 状态管理存储

#### 用户状态 (`src/stores/user.ts`)
- Token存储：使用`uni.setStorageSync('token', token)`
- 自动登录信息：使用自定义存储工具`setStorage()`
- 用户基本信息：使用自定义存储工具`setStorage()`

#### 城市状态 (`src/stores/city.ts`)
- 当前城市信息：使用`uni.setStorageSync('currentCity', cityInfo)`
- 定位信息：使用`uni.setStorageSync('currentLocation', locationInfo)`
- 配置了pinia持久化插件

#### 字典状态 (`src/stores/dict.ts`)
- 字典缓存：通过pinia持久化插件自动存储

## 存储特性

### 1. 数据过期机制
```typescript
// 支持设置过期时间
setStorage('key', value, 7 * 24 * 60 * 60 * 1000) // 7天过期
```

### 2. 错误处理
所有存储操作都包含完整的错误处理：
```typescript
try {
  uni.setStorageSync(key, value)
  return true
} catch (error) {
  console.error('存储数据失败:', error)
  return false
}
```

### 3. 存储信息查询
```typescript
// 检查存储是否可用
isStorageAvailable()

// 获取存储信息
getStorageInfo() // 返回 { keys, currentSize, limitSize }
```

## 微信小程序限制

### 1. 存储大小限制
- 微信小程序本地存储单个key最大1MB
- 总存储空间限制为10MB
- 建议合理控制存储数据大小

### 2. 存储清理
- 微信小程序在以下情况会清理存储：
  - 用户主动删除小程序
  - 存储空间不足时
  - 小程序版本更新时（部分情况）

### 3. 异步存储
虽然项目主要使用同步API，但uni-app也提供了异步版本：
```typescript
// 异步存储（可选使用）
uni.setStorage({
  key: 'key',
  data: 'value',
  success: () => console.log('存储成功'),
  fail: (error) => console.error('存储失败', error)
})
```

## 最佳实践

### 1. 数据压缩
对于大量数据，建议进行压缩：
```typescript
// 示例：压缩JSON数据
const compressedData = JSON.stringify(largeData)
setStorage('largeData', compressedData)
```

### 2. 数据分片
对于超大数据，建议分片存储：
```typescript
// 示例：分片存储
const chunks = splitData(largeData, 1000) // 每片1000条
chunks.forEach((chunk, index) => {
  setStorage(`data_chunk_${index}`, chunk)
})
```

### 3. 定期清理
建议定期清理过期或无用数据：
```typescript
// 示例：清理过期数据
const keys = getStorageKeys()
keys.forEach(key => {
  const data = getStorage(key)
  if (!data) {
    removeStorage(key) // 清理无效数据
  }
})
```

## 兼容性检查

项目已通过以下兼容性检查：

✅ 使用uni-app统一存储API
✅ 避免使用localStorage/sessionStorage
✅ 避免使用IndexedDB
✅ 配置pinia持久化插件
✅ 完整的错误处理机制
✅ 支持数据过期机制
✅ 微信小程序manifest.json配置正确

## 注意事项

1. **不要使用浏览器专用API**：避免使用`localStorage`、`sessionStorage`、`IndexedDB`等
2. **数据序列化**：存储复杂对象时使用`JSON.stringify()`
3. **错误处理**：所有存储操作都要有错误处理
4. **存储限制**：注意微信小程序的存储大小限制
5. **数据安全**：敏感数据不要存储在本地存储中

## 测试建议

在微信开发者工具中测试以下场景：

1. 正常存储和读取数据
2. 存储空间不足时的处理
3. 数据过期机制
4. 网络异常时的存储操作
5. 小程序重启后的数据恢复

通过以上配置，项目已完全兼容微信小程序的存储机制，可以安全地在微信小程序环境中使用。
