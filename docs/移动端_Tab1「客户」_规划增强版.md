# 移动端 Tab1「客户」规划增强版（可落地研发版）

> 目标：把「客户全生命周期管理」在移动端 Tab1 里落到 **可实现的页面/字段/权限/流程/接口约定**，确保实体与功能无歧义、可直接进入任务拆解与排期。
>
> 来源：基于 `docs/移动端_5Tabs_界面规划.md` 的 Tab1（P1-1 ~ P1-10）并结合 `docs/需求.md`、`docs/需求_整理版.md` 的口径补齐细则。

---

## 0. 统一口径（一期必须遵守）

### 0.1 实体口径：线索 vs 客户
- **不做两套实体**：线索与客户统一为同一实体（下文统称 **客户**）。
- **按 `status` 分段**：Tab1 顶部分段（公海/跟进/交案/回款/赢单）= `status` 的不同值。

### 0.2 状态流转规则（触发条件已确认）
- **公海 → 跟进**：审批通过 + 分配经办人 即转
- **跟进 → 交案**：合同确认完成 即转
- **交案 → 回款**：新增回款记录 即转（支持多笔）
- **回款 → 赢单**：新增律师费记录 即转（支持多笔）

### 0.3 回收风险口径（后端计算，前端只展示/筛选）
回收规则（一期）：
- 领取线索后 **1 个月内未形成有效拜访**
- 客户进入跟进状态后 **6 个月内未交案**
- 客户赢单后 **6 个月内无新合同**

后端返回字段（列表聚合字段）：
- `recycle_risk_level`：风险等级（如 none/low/medium/high，具体枚举由后端统一）
- `recycle_deadline`：回收截止时间（datetime）

### 0.4 枚举统一：生命周期（status）与展业状态（sales_stage）
> 口径：生命周期由 `status` 表示；展业由后端派生字段 `sales_stage` 表示（用于列表筛选与运营漏斗）。

- `status` 枚举（统一大写）：
  - `PUBLIC_POOL`：公海
  - `FOLLOW_UP`：跟进
  - `CASE`：交案
  - `PAYMENT`：回款
  - `WON`：赢单
- `sales_stage`（后端计算返回）：
  - `PUBLIC_POOL`：当 `status=PUBLIC_POOL`
  - `BLANK`：当 `status=FOLLOW_UP && valid_visit_count==0`（哪怕有电话跟进记录，未面谈前仍算空白）
  - `MEETING`：当 `status=FOLLOW_UP && valid_visit_count>0`
    - `valid_visit` 判定：`location_status=success` **或** `lng/lat` 任一非空
  - `CASE` / `PAYMENT` / `WON`：当 `status` 分别为 `CASE` / `PAYMENT` / `WON`（展业状态等同生命周期）

---

## 1. 角色与数据范围（升级：总所/分所/团队/销售）

> 原则：采用“角色 - 权限 - 数据范围”控制；在原三层（总所/分所/销售）基础上新增 **团队** 层级。

### 1.1 角色定义
- **总所管理（HQ）**：仅管理职能（无销售职能），全所范围管理与审阅，具备最高管理权限
- **分所管理（BRANCH）**：仅管理职能（无销售职能），本所范围管理与审阅
- **团队（TEAM）**：基层管理 + 也具备销售职能
  - 管理职能：本团队范围管理与审阅（介于分所与销售之间），能看到团队内销售人员
  - 销售职能：可作为经办人（owner）推进自己的客户全流程
- **销售（SALES）**：仅销售职能，个人负责客户的执行与录入（跟进/拜访/计划/合同/回款/费用）

### 1.2 数据范围（推荐口径）
- **总所管理**：全所
- **分所管理**：本所
- **团队管理**：本团队
- **销售**：本人负责（owner=自己）+ 可申领范围内的公海

### 1.4 AI 接入与扩展点（统一要求）
> 所有 Tab1 相关功能必须预留 AI 接入点（对话/抽取/建议卡片/可执行动作）与可追溯字段（trace_id、ai_source、附件入库），统一规范见：`docs/AI接入与扩展点规范.md`。

### 1.3 申领公海线索审批链（层层审批：团队→分所→总所）
> 你反馈当前“管理没有层层审批”，这里统一为 **逐级审批**，确保权限与责任链路可追溯。

- **默认审批链（逐级）**：
  - 申请人是 SALES/TEAM：`TEAM → BRANCH → HQ`
  - 申请人是 BRANCH：`BRANCH → HQ`
  - 申请人是 HQ：`HQ`
  - 若组织缺失某层级审批人，则自动跳过该层，进入上一级（后端可配置）
- **审批结果**：
  - **全部层级通过**：分配经办人（默认=申请人）→ `status` 转为 `FOLLOW_UP`
  - **任一层级驳回**：保持 `PUBLIC_POOL`，记录 `reject_reason` + 审批历史

---

## 2. 数据对象与字段（面向移动端的一期最小集）

> 命名说明：参与人员不再使用 `Internal_Staff` / `External_Contacts` 这类抽象名，直接对齐你要求的命名风格。

### 2.1 用户表（内部参与人员来源）
- 后端用户模型：`Users`
- 数据表：`lsl_system_users`（由系统表前缀 + `system_users` 组成）

### 2.2 客户（建议表名：`client`）
> 客户表名你已指定“ `client`”，本文档按 `client` 口径描述（实际后端若有不同，以后端表/接口为准）。

字段（一期最小集）：
- `id`
- `status`：`PUBLIC_POOL` / `FOLLOW_UP` / `CASE` / `PAYMENT` / `WON`
- `client_name`：公司/客户名（必填）
- `contact_name`：联系人（可选）
- `mobile`：手机号（可选但强建议）
- `region`：地区（可选）
- `source_channel`：来源渠道（可选）
- `referrer`：引荐人（可选）
- `demand_summary`：需求摘要（可选）
- `owner_user_id`：经办人（必填，指向 `lsl_system_users.id`）
- `org_scope`：所属分所/团队（用于数据范围控制，字段形态由后端决定）

AI/人工标记（人工权重最高）：
- `grade`：A/B/C/D（带来源：ai/manual；展示与统计以 manual 为准）
- `collection_category`：仲裁/调解/诉讼（支持主次；历史变更需记录日志）
- `preservation_status`：保全/非保全（可选一期先做枚举）
- `court`：管辖法院（可选）
- `lawyer`：案件律师（可选）

列表聚合字段（由列表接口直接返回，前端不临时计算）：
- `last_followup_at`
- `last_visit_at`
- `next_plan_at`
- `recycle_risk_level`
- `recycle_deadline`

列表统计/派生字段（由列表接口直接返回，前端不计算）：
- `followup_count`：跟进记录数
- `visit_count`：拜访记录数
- `valid_visit_count`：有效拜访数（判定见 `sales_stage` 口径）
- `sales_stage`：展业状态（判定见 `sales_stage` 口径）

### 2.3 客户联系人（外部参与人员：`client_contacts`）
用途：用于拜访/跟进的“客户方参与人员”结构化选择，支持“手动输入或绑定联系人表”。

最小字段建议：
- `id`
- `client_id`
- `name`
- `mobile`（可选）
- `position`（可选）

### 2.4 跟进记录（followup）
- `time`
- `type`：电话/微信/面谈/其他
- `summary`（必填）
- `conclusion`（可选）
- `attachments`（图片/录音/文件）
- `next_plan_at`（可选；可一键生成日程）

### 2.5 拜访足迹（visit）
参与人员（结构化）：
- `system_users`：内部参与人员（多选 `lsl_system_users.id`）
- `client_contacts`：客户方参与人员（多选 `client_contacts.id`，也允许临时手输）

定位（非强制，但强提示）：
- `location_status`：success / fail / denied / offline
- `lng`/`lat`（可空）
- `address`（可手输兜底）

### 2.6 跟进计划（plan）
- `title`
- `time_points`（多条）
- `remind`：方式 + 提前量（读取个人偏好，可二次编辑）
- `client_id`

### 2.7 合同（contract，一期最小字段 + 附件）
一期“识别”不强依赖，必须支持 **上传 + 手工填写最小字段**：
- `contract_no`
- `amount`
- `term`
- `service_type`
- `client_subject`
- `attachments`

合同确认完成 → 生成最小案件字段 → 状态转交案。

### 2.8 案件（case，一期最小字段）
先做“合同 + 最小案件字段”，不强制对接外部案件系统：
- `case_name`（可默认：客户名 + 服务类型）
- `case_type`（可选）
- `amount`（可引用合同）
- `status`（可选）

### 2.9 回款记录（recovery_payment）
- `pay_time`、`amount`、`voucher_attachments`
- `collection_category`：仲裁/调解/诉讼（避免误叫“回款方式”）

### 2.10 律师费用（legal_fee）
- `pay_time`、`amount`、`voucher_attachments`

---

## 3. Tab1 页面规划（增强版）

### P1-1 客户列表页（五段分栏）
分段：公海 / 跟进 / 交案 / 回款 / 赢单（= 生命周期 `status`）

搜索：
- 客户名/公司名/联系人/手机号（一期至少支持 客户名/手机号）

筛选（一期必须支持两维）：
- 生命周期（`status`）
- 展业（`sales_stage`，默认显示：公海 / 空白 / 面谈 / 交案 / 回款 / 赢单）
- 客户等级 A/B/C/D（人工优先）
- 催收类别（仲裁/调解/诉讼）
- 经办人（管理可用；销售默认自己）
- 分所/团队（管理可用）
- 临近回收（`recycle_risk_level`）

排序：最近跟进 / 最近创建 / 最近拜访（依赖聚合字段）

卡片展示（接口直接返回聚合字段）：
- 客户名 + 等级（来源 AI/人工）
- 当前状态（生命周期 `status`；必要时可同时展示展业 `sales_stage`）
- `last_followup_at` / `next_plan_at`
- 标签：催收类别、保全、`recycle_risk_level` + `recycle_deadline`
- 经办人（管理可见）

动作：
- 销售：公海申领（走审批）；非公海进入详情 + 快捷新增
- 管理（总所/分所/团队）：公海分配/审核；按数据范围查看

### P1-2 客户详情页（统一详情，按状态动态模块）
顶部固定区：
- 客户名称/简称、状态、等级（人工优先）、经办人
- 回收风险：`recycle_risk_level` + `recycle_deadline`
- 快捷动作：新增跟进、记录拜访、添加计划、AI 对话（带客户上下文）

模块（折叠面板）：
- 基础信息
- AI 标记（确认/修正，写入日志，人工权重最高）
- 跟进时间线
- 拜访足迹（含定位与参与人员结构化）
- 跟进计划（可同步 Tab2 日程）
- 合同与案件（交案后显示）
- 回款记录（回款后显示）
- 律师费用（赢单后显示）
- 转交日志（按权限可见）

关键规则提示（UI）：
- 经办人必填；申领/转交需审批；关键字段修改需二次确认

### P1-3 新增线索/客户页
用途：录入公海线索或销售自有线索（同一实体）。

字段：
- 公司/客户名、联系人、手机号、地区、需求摘要、来源渠道、引荐人
- 经办人：默认当前人；管理可改

流程：
- 销售新增自有线索：提交 → 待审核 → 审核通过后进入公海（你已确认）
- 管理新增：直接进入公海，可分配

### P1-4 新增跟进记录页
字段：
- 跟进方式、摘要（必填）、关键结论（可选）
- 是否需要下次跟进 + 时间（可一键生成日程）
- 附件：图片/录音/文件（失败重试）

### P1-5 记录拜访页（含“定位兜底”）
字段：
- 拜访时间、洽谈时长、核心价值信息
- 地点（强提示定位但不强制；允许手输地址）
- 参与人员：
  - `system_users`：内部用户多选（来源 `lsl_system_users`）
  - `client_contacts`：客户联系人多选（来源 `client_contacts`，也允许临时手输）
- 附件：照片/录音/文档

定位兜底 UI（必须有）：
- 定位失败：可重试 / 手输地址
- 拒绝授权：引导去系统设置开启
- 无网：允许离线保存，网络恢复后补传定位/附件

### P1-6 跟进计划页（新增/编辑）
- 计划事项、时间点（可多条）
- 关联客户（默认带入）
- 提醒方式与提前量（读取个人偏好）
- 保存后同步到 Tab2 日程

### P1-7 合同上传与确认页（一期）
流程：
- 上传合同附件（PDF/Word/图片）
- 手工填写最小字段：合同编号、合同金额、期限、服务类型、客户主体
- 确认完成 → 生成合同档案 + 最小案件字段 → 状态转交案

### P1-8 回款录入页（一期）
- 回款时间、金额、催收类别（仲裁/调解/诉讼）、凭证上传
- 保存成功 → 状态转回款（支持多笔）

### P1-9 律师费用录入页（一期）
- 支付时间、金额、凭证上传
- 保存成功 → 状态转赢单（支持多笔）

### P1-10 客户转交申请页（销售发起）
- 目标经办人、转交原因（必填）、备注/附件（可选）
- 审批：团队/分所/总所按数据范围与就近原则
- 审批通过：owner 变更 + 历史数据对新经办人可见 + 生成转交日志

---

## 4. 最终确认清单（实体/功能/接口是否明确）

- 实体唯一：客户统一实体，按 `status` 分段
- 流转触发：4 个流转点绑定到明确事件（审批/合同确认/新增回款/新增律师费）
- 权限层级：总所/分所/团队/销售 + 数据范围明确
- 参与人员：内部来源 `lsl_system_users`；外部来源 `client_contacts`
- 定位：非强制强提示 + 三种兜底 UI（失败/拒绝/无网）
- 列表字段：聚合字段由列表接口直接返回（含回收风险字段）
- 回收风险：后端计算并返回 `recycle_risk_level/recycle_deadline`
- 合同/案件：一期做“上传 + 手工最小字段”与“最小案件字段”


