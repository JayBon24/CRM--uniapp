# å¾®ä¿¡å°ç¨‹åºæƒé™ç³»ç»Ÿä½¿ç”¨è¯´æ˜

## ğŸ” å…¼å®¹æ€§è¯´æ˜

### 1. å¾®ä¿¡å°ç¨‹åºé™åˆ¶
- âŒ **ä¸æ”¯æŒ Vue è‡ªå®šä¹‰æŒ‡ä»¤** (`v-hasPermi`)
- âŒ **ä¸æ”¯æŒåŠ¨æ€ç»„ä»¶æ¸²æŸ“**
- âŒ **éƒ¨åˆ† Vue æŒ‡ä»¤åŠŸèƒ½å—é™**

### 2. è§£å†³æ–¹æ¡ˆ
- âœ… **ä½¿ç”¨æƒé™ç»„ä»¶åŒ…è£…** (`PermissionWrapper`)
- âœ… **ä½¿ç”¨è®¡ç®—å±æ€§æ§åˆ¶æ˜¾ç¤º**
- âœ… **ä½¿ç”¨æ¡ä»¶æ¸²æŸ“** (`v-if`)
- âœ… **ä½¿ç”¨æƒé™éªŒè¯æ–¹æ³•**

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
æƒé™ç³»ç»Ÿæ¶æ„ï¼ˆå¾®ä¿¡å°ç¨‹åºå…¼å®¹ç‰ˆï¼‰ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·ç™»å½•      â”‚    â”‚   è·å–ç”¨æˆ·ä¿¡æ¯   â”‚    â”‚   æƒé™éªŒè¯      â”‚
â”‚   (user.ts)     â”‚â”€â”€â”€â–¶â”‚   (getInfo)     â”‚â”€â”€â”€â–¶â”‚   (auth.ts)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Tokenå­˜å‚¨     â”‚    â”‚   æƒé™å­˜å‚¨      â”‚    â”‚   æƒé™ç»„ä»¶      â”‚
â”‚   (auth.ts)     â”‚    â”‚   (user.ts)     â”‚    â”‚(PermissionWrapper)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ user.ts                    # ç”¨æˆ·çŠ¶æ€ç®¡ç†
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ auth.ts                    # æƒé™éªŒè¯å·¥å…·
â”œâ”€â”€ components/
â”‚   â””â”€â”€ PermissionWrapper/         # æƒé™åŒ…è£…ç»„ä»¶
â”‚       â””â”€â”€ index.vue
â”œâ”€â”€ api/
â”‚   â””â”€â”€ user.ts                    # ç”¨æˆ·ç›¸å…³API
â”œâ”€â”€ mock/
â”‚   â””â”€â”€ user.ts                    # ç”¨æˆ·Mockæ•°æ®
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ test-permission/           # æµ‹è¯•é¡µé¢
â””â”€â”€ main.ts                        # åº”ç”¨å…¥å£
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. æƒé™éªŒè¯å·¥å…· (`src/utils/auth.ts`)

```typescript
import auth from '@/utils/auth'

// å•ä¸ªæƒé™éªŒè¯
const hasPermission = auth.hasPermi('system:user:add')

// å¤šä¸ªæƒé™éªŒè¯ï¼ˆæˆ–å…³ç³»ï¼‰
const hasAnyPermission = auth.hasPermiOr(['system:user:add', 'system:user:edit'])

// å¤šä¸ªæƒé™éªŒè¯ï¼ˆä¸”å…³ç³»ï¼‰
const hasAllPermissions = auth.hasPermiAnd(['system:user:add', 'system:user:export'])

// è·å–ç”¨æˆ·æƒé™åˆ—è¡¨
const permissions = auth.getUserPermissions()

// æ£€æŸ¥ç™»å½•çŠ¶æ€
const isLoggedIn = auth.isLoggedIn()
```

### 2. æƒé™åŒ…è£…ç»„ä»¶ (`src/components/PermissionWrapper/index.vue`)

```vue
<template>
  <view v-if="hasPermission" class="permission-wrapper">
    <slot></slot>
  </view>
</template>

<script setup lang="ts">
import auth from '@/utils/auth'

interface Props {
  permission?: string | string[]
  requireAll?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  permission: '',
  requireAll: false
})

const hasPermission = computed(() => {
  if (!props.permission) return true

  if (Array.isArray(props.permission)) {
    return props.requireAll
      ? auth.hasPermiAnd(props.permission)
      : auth.hasPermiOr(props.permission)
  } else {
    return auth.hasPermi(props.permission)
  }
})
</script>
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. ä½¿ç”¨æƒé™ç»„ä»¶åŒ…è£…

#### å•ä¸ªæƒé™æ§åˆ¶
```vue
<template>
  <view>
    <!-- ä½¿ç”¨æƒé™ç»„ä»¶åŒ…è£…æŒ‰é’® -->
    <PermissionWrapper permission="system:user:add">
      <u-button type="primary" @click="handleAdd">
        æ–°å¢ç”¨æˆ·
      </u-button>
    </PermissionWrapper>

    <!-- ä½¿ç”¨æƒé™ç»„ä»¶åŒ…è£…è¡¨å• -->
    <PermissionWrapper permission="system:user:edit">
      <u-form>
        <u-form-item label="ç”¨æˆ·å">
          <u-input v-model="form.username" />
        </u-form-item>
      </u-form>
    </PermissionWrapper>
  </view>
</template>

<script setup lang="ts">
import PermissionWrapper from '@/components/PermissionWrapper/index.vue'
</script>
```

#### å¤šä¸ªæƒé™æ§åˆ¶ï¼ˆæˆ–å…³ç³»ï¼‰
```vue
<template>
  <view>
    <!-- å…·å¤‡ä»»ä¸€æƒé™å³å¯æ˜¾ç¤º -->
    <PermissionWrapper permission="['system:user:add', 'system:user:edit']">
      <u-button type="success" @click="handleEdit">
        ç¼–è¾‘ç”¨æˆ·
      </u-button>
    </PermissionWrapper>
  </view>
</template>
```

#### å¤šä¸ªæƒé™æ§åˆ¶ï¼ˆä¸”å…³ç³»ï¼‰
```vue
<template>
  <view>
    <!-- éœ€è¦åŒæ—¶å…·å¤‡æ‰€æœ‰æƒé™ -->
    <PermissionWrapper permission="['system:user:add', 'system:user:export']" :requireAll="true">
      <u-button type="warning" @click="handleExport">
        å¯¼å‡ºç”¨æˆ·
      </u-button>
    </PermissionWrapper>
  </view>
</template>
```

### 2. åœ¨JavaScriptä¸­ä½¿ç”¨æƒé™éªŒè¯

```typescript
import auth from '@/utils/auth'

// åœ¨æ–¹æ³•ä¸­éªŒè¯æƒé™
const handleAddUser = () => {
  if (!auth.hasPermi('system:user:add')) {
    uni.showToast({
      title: 'æƒé™ä¸è¶³',
      icon: 'error'
    })
    return
  }

  // æ‰§è¡Œæ–°å¢æ“ä½œ
  console.log('æ‰§è¡Œæ–°å¢ç”¨æˆ·æ“ä½œ')
}

// åœ¨è®¡ç®—å±æ€§ä¸­ä½¿ç”¨
const canEdit = computed(() => {
  return auth.hasPermi('system:user:edit')
})

// åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨
const canDelete = computed(() => {
  return auth.hasPermi('system:user:remove')
})
```

### 3. æ¡ä»¶æ¸²æŸ“æ§åˆ¶

```vue
<template>
  <view>
    <!-- ä½¿ç”¨è®¡ç®—å±æ€§æ§åˆ¶æ˜¾ç¤º -->
    <u-button v-if="canAdd" type="primary" @click="handleAdd">
      æ–°å¢ç”¨æˆ·
    </u-button>

    <u-button v-if="canEdit" type="success" @click="handleEdit">
      ç¼–è¾‘ç”¨æˆ·
    </u-button>

    <u-button v-if="canDelete" type="error" @click="handleDelete">
      åˆ é™¤ç”¨æˆ·
    </u-button>
  </view>
</template>

<script setup lang="ts">
import auth from '@/utils/auth'

// è®¡ç®—å±æ€§ - æƒé™æ£€æŸ¥
const canAdd = computed(() => auth.hasPermi('system:user:add'))
const canEdit = computed(() => auth.hasPermi('system:user:edit'))
const canDelete = computed(() => auth.hasPermi('system:user:remove'))
</script>
```

## ğŸ¯ æƒé™æ ‡è¯†è§„èŒƒ

### æƒé™æ ‡è¯†æ ¼å¼
é‡‡ç”¨ä¸‰æ®µå¼å‘½åè§„èŒƒï¼š`æ¨¡å—:åŠŸèƒ½:æ“ä½œ`

**ç¤ºä¾‹**:
```
system:user:add      # ç³»ç»Ÿç”¨æˆ·ç®¡ç†-æ–°å¢
system:user:edit     # ç³»ç»Ÿç”¨æˆ·ç®¡ç†-ä¿®æ”¹
system:user:remove   # ç³»ç»Ÿç”¨æˆ·ç®¡ç†-åˆ é™¤
system:user:export   # ç³»ç»Ÿç”¨æˆ·ç®¡ç†-å¯¼å‡º
zhule:agent:query    # ä¸»ç†ä»£ç†å•†ç®¡ç†-æŸ¥è¯¢
```

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. è®¿é—®æµ‹è¯•é¡µé¢
```
è·¯å¾„: /pages/test-permission/index
```

### 2. æµ‹è¯•æ­¥éª¤
1. **æ¨¡æ‹Ÿç™»å½•**: ç‚¹å‡»"æ¨¡æ‹Ÿç™»å½•"æŒ‰é’®
2. **è§‚å¯Ÿæƒé™æŒ‰é’®**: æŸ¥çœ‹å“ªäº›æŒ‰é’®æ˜¾ç¤º/éšè—
3. **æµ‹è¯•æƒé™éªŒè¯**: ç‚¹å‡»æŒ‰é’®æµ‹è¯•æƒé™éªŒè¯åŠŸèƒ½
4. **æŸ¥çœ‹æƒé™çŠ¶æ€**: è§‚å¯Ÿæƒé™çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
5. **æµ‹è¯•æƒé™æ–¹æ³•**: ç‚¹å‡»"æµ‹è¯•æƒé™éªŒè¯æ–¹æ³•"æŒ‰é’®

### 3. æµ‹è¯•å†…å®¹
- âœ… å•ä¸ªæƒé™æ§åˆ¶
- âœ… å¤šä¸ªæƒé™æ§åˆ¶ï¼ˆæˆ–å…³ç³»ï¼‰
- âœ… å¤šä¸ªæƒé™æ§åˆ¶ï¼ˆä¸”å…³ç³»ï¼‰
- âœ… æƒé™éªŒè¯æ–¹æ³•
- âœ… ç”¨æˆ·çŠ¶æ€ç®¡ç†

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### 1. å‰ç«¯å®‰å…¨
- Token æœ¬åœ°å­˜å‚¨
- æƒé™ç»„ä»¶æ§åˆ¶
- ç”¨æˆ·çŠ¶æ€ç®¡ç†
- é”™è¯¯å¤„ç†æœºåˆ¶

### 2. åç«¯å®‰å…¨ï¼ˆéœ€è¦é…åˆï¼‰
- Token éªŒè¯
- æƒé™éªŒè¯
- æ•°æ®æƒé™æ§åˆ¶

### 3. æœ€ä½³å®è·µ
- æœ€å°æƒé™åŸåˆ™
- èŒè´£åˆ†ç¦»
- æƒé™ç²’åº¦æ§åˆ¶
- é”™è¯¯ä¿¡æ¯ä¸æ³„éœ²æ•æ„Ÿæ•°æ®

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æƒé™ç¼“å­˜
- ç”¨æˆ·æƒé™æ•°æ®ç¼“å­˜
- æƒé™éªŒè¯ç»“æœç¼“å­˜
- é¿å…é‡å¤çš„æƒé™éªŒè¯

### 2. ç»„ä»¶ä¼˜åŒ–
- æƒé™ç»„ä»¶æŒ‰éœ€æ¸²æŸ“
- è®¡ç®—å±æ€§ç¼“å­˜
- é”™è¯¯å¤„ç†ä¼˜åŒ–

## ğŸ”§ æ•…éšœæ’é™¤

### 1. å¸¸è§é—®é¢˜

#### 1.1 æƒé™ç»„ä»¶ä¸æ˜¾ç¤º
**å¯èƒ½åŸå› **:
- ç”¨æˆ·æœªç™»å½•
- æƒé™æ•°æ®æœªæ­£ç¡®åŠ è½½
- æƒé™æ ‡è¯†æ ¼å¼é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
2. ç¡®è®¤æƒé™æ•°æ®å·²æ­£ç¡®è·å–
3. æ£€æŸ¥æƒé™æ ‡è¯†æ ¼å¼

#### 1.2 æƒé™éªŒè¯å¤±è´¥
**å¯èƒ½åŸå› **:
- Token è¿‡æœŸ
- æƒé™æ•°æ®ä¸ºç©º
- æƒé™æ ‡è¯†ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**:
1. é‡æ–°ç™»å½•è·å–æ–°çš„ Token
2. æ£€æŸ¥æƒé™æ•°æ®æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤æƒé™æ ‡è¯†ä¸åç«¯è¿”å›çš„æƒé™åŒ¹é…

### 2. è°ƒè¯•æ–¹æ³•

#### 2.1 æ§åˆ¶å°è°ƒè¯•
```javascript
// æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
console.log('ç”¨æˆ·ä¿¡æ¯:', userStore.userInfo)
console.log('æƒé™åˆ—è¡¨:', userStore.permissions)

// æ£€æŸ¥æƒé™éªŒè¯
console.log('æƒé™éªŒè¯ç»“æœ:', auth.hasPermi('system:user:add'))
```

#### 2.2 ç»„ä»¶è°ƒè¯•
```vue
<!-- åœ¨æ¨¡æ¿ä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯ -->
<view>ç”¨æˆ·çŠ¶æ€: {{ userStore.hasToken ? 'å·²ç™»å½•' : 'æœªç™»å½•' }}</view>
<view>æƒé™æ•°é‡: {{ userStore.permissions.length }}</view>
<view>æ–°å¢æƒé™: {{ auth.hasPermi('system:user:add') ? 'æœ‰' : 'æ— ' }}</view>
```

## âœ… éªŒè¯æ¸…å•

### 1. åŠŸèƒ½éªŒè¯
- [ ] ç”¨æˆ·ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] æƒé™æ•°æ®æ­£ç¡®åŠ è½½
- [ ] æƒé™ç»„ä»¶æ­£å¸¸å·¥ä½œ
- [ ] æƒé™éªŒè¯åŠŸèƒ½æ­£å¸¸
- [ ] æµ‹è¯•é¡µé¢å¯ä»¥è®¿é—®

### 2. å…¼å®¹æ€§éªŒè¯
- [ ] H5 ç¯å¢ƒæ­£å¸¸
- [ ] å¾®ä¿¡å°ç¨‹åºç¯å¢ƒæ­£å¸¸
- [ ] å…¶ä»–å¹³å°ç¯å¢ƒæ­£å¸¸

### 3. æ€§èƒ½éªŒè¯
- [ ] é¡µé¢åŠ è½½é€Ÿåº¦æ­£å¸¸
- [ ] æƒé™éªŒè¯å“åº”åŠæ—¶
- [ ] å†…å­˜å ç”¨åˆç†

## ğŸ‰ æ€»ç»“

å¾®ä¿¡å°ç¨‹åºå…¼å®¹ç‰ˆæƒé™ç³»ç»Ÿå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **å®Œå…¨å…¼å®¹**: è§£å†³äº†å¾®ä¿¡å°ç¨‹åºä¸æ”¯æŒ Vue æŒ‡ä»¤çš„é—®é¢˜
2. **ç»„ä»¶åŒ–è®¾è®¡**: ä½¿ç”¨æƒé™ç»„ä»¶åŒ…è£…ï¼Œä»£ç æ›´æ¸…æ™°
3. **çµæ´»æ§åˆ¶**: æ”¯æŒå•ä¸ªã€å¤šä¸ªæƒé™çš„çµæ´»æ§åˆ¶
4. **æ€§èƒ½ä¼˜åŒ–**: åŒ…å«ç¼“å­˜å’Œé”™è¯¯å¤„ç†æœºåˆ¶
5. **æ˜“äºä½¿ç”¨**: æä¾›ç®€æ´çš„ API å’Œç»„ä»¶æ¥å£

é€šè¿‡åˆç†ä½¿ç”¨æœ¬æƒé™ç³»ç»Ÿï¼Œå¯ä»¥åœ¨å¾®ä¿¡å°ç¨‹åºä¸­å®ç°å®Œæ•´çš„æƒé™æ§åˆ¶åŠŸèƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿå®‰å…¨æ€§ã€‚
