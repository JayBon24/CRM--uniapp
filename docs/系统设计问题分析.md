# 系统角色权限与流程设计问题分析

> 本文档分析了当前CRM系统设计中存在的不合理之处和改进建议。

---

## 一、审批链设计问题

### ❌ 问题1：TEAM 申领公海客户需要自己审批自己

**问题描述**：
- 当前设计：TEAM 申领公海客户，审批链是 `TEAM → BRANCH → HQ`
- **问题**：TEAM 作为第一级审批人，需要审批自己的申请，这在逻辑上不合理

**代码证据**：
```typescript
// src/mock/approval-store.ts
export function buildApprovalChain(applicantRole: UserRoleLevel): UserRoleLevel[] {
  if (applicantRole === 'HQ') return ['HQ']
  if (applicantRole === 'BRANCH') return ['BRANCH', 'HQ']
  return ['TEAM', 'BRANCH', 'HQ']  // ❌ TEAM 申领时，自己审批自己
}
```

**改进建议**：
- ✅ **方案1（推荐）**：TEAM 申领时，审批链应该是 `BRANCH → HQ`（跳过自己）
- ✅ **方案2**：TEAM 申领时，如果自己是团队负责人，则直接进入 BRANCH 审批

**修改后的审批链规则**：
```typescript
export function buildApprovalChain(applicantRole: UserRoleLevel): UserRoleLevel[] {
  if (applicantRole === 'HQ') return ['HQ']
  if (applicantRole === 'BRANCH') return ['BRANCH', 'HQ']
  if (applicantRole === 'TEAM') return ['BRANCH', 'HQ']  // ✅ 跳过自己
  return ['TEAM', 'BRANCH', 'HQ']  // SALES 申领
}
```

---

### ❌ 问题2：HQ/BRANCH 不能申领但审批链支持申领

**问题描述**：
- 文档中明确：HQ 和 BRANCH **不能申领公海客户**（❌）
- 但代码中的审批链构建函数支持 HQ/BRANCH 申领的场景
- **矛盾**：如果 HQ/BRANCH 不能申领，为什么还要设计他们的审批链？

**文档中的描述**：
- HQ：❌ 不能申领公海客户
- BRANCH：❌ 不能申领公海客户
- TEAM：✅ 可以申领（需审批）
- SALES：✅ 可以申领（需审批）

**代码中的设计**：
```typescript
if (applicantRole === 'HQ') return ['HQ']  // 支持 HQ 申领
if (applicantRole === 'BRANCH') return ['BRANCH', 'HQ']  // 支持 BRANCH 申领
```

**改进建议**：
- ✅ **方案1（推荐）**：允许 HQ/BRANCH 申领，但审批链简化（HQ 自己审批，BRANCH 只需 HQ 审批）
- ✅ **方案2**：保持不能申领，但删除相关审批链代码，避免混淆

**如果采用方案1，需要更新文档**：
- HQ：✅ 可以申领（自己审批即可）
- BRANCH：✅ 可以申领（需 HQ 审批）

---

## 二、角色权限冲突问题

### ❌ 问题3：HQ/BRANCH 分配客户给自己的边界情况

**问题描述**：
- HQ/BRANCH 可以分配公海客户给任意销售人员
- 但 HQ/BRANCH **不能作为经办人推进客户**（无销售职能）
- **问题**：如果 HQ/BRANCH 分配客户给自己，会发生什么？
  - 系统是否允许？
  - 如果允许，他们能否推进客户？
  - 如果不允许，如何限制？

**当前文档描述**：
- HQ/BRANCH：✅ 可以分配客户给他人
- HQ/BRANCH：❌ 不能作为经办人推进客户

**改进建议**：
- ✅ **方案1（推荐）**：分配时禁止 HQ/BRANCH 选择自己作为经办人（前端限制 + 后端校验）
- ✅ **方案2**：允许分配给自己，但限制操作权限（只能查看，不能推进）

---

### ❌ 问题4：TEAM 双重职能的权限边界不清晰

**问题描述**：
- TEAM 既有管理职能也有销售职能
- **问题**：
  1. TEAM 审批自己团队的申领申请时，是否应该回避？
  2. TEAM 是否可以审批自己的申领申请？
  3. TEAM 作为经办人时，是否还能审批其他申请？

**改进建议**：
- ✅ **明确规则**：
  1. TEAM 申领时，审批链跳过自己（见问题1）
  2. TEAM 审批时，如果申请人是自己，则自动跳过或转给上级
  3. TEAM 作为经办人时，仍可审批其他申请（管理职能不受影响）

---

## 三、数据权限问题

### ❌ 问题5：客户转交后原经办人的数据访问权限

**问题描述**：
- 文档只说："历史数据对新经办人可见"
- **问题**：
  1. 转交后，原经办人是否还能查看该客户的历史数据？
  2. 原经办人是否还能查看该客户的后续进展？
  3. 原经办人的历史跟进记录、拜访记录等是否对新经办人可见？

**当前文档描述**：
- 转交：`owner_user_id` 变更 + 生成转交日志
- 历史数据对新经办人可见

**改进建议**：
- ✅ **方案1（推荐）**：
  - 原经办人：可以查看转交前的历史数据（只读），不能查看转交后的新数据
  - 新经办人：可以查看全部历史数据（包括转交前的）
- ✅ **方案2**：
  - 原经办人：完全失去访问权限（除非是管理角色）
  - 新经办人：可以查看全部历史数据

**需要明确的字段**：
- `handover_at`：转交时间
- `previous_owner_id`：原经办人ID
- `current_owner_id`：当前经办人ID

---

### ❌ 问题6：管理角色查看他人客户数据的边界

**问题描述**：
- HQ 可以查看全所客户数据
- BRANCH 可以查看本分所客户数据
- TEAM 可以查看本团队客户数据
- **问题**：
  1. 管理角色是否可以编辑他人负责的客户？
  2. 管理角色是否可以修改客户的关键信息（如经办人、联系方式）？
  3. 管理角色是否可以代替经办人推进客户（如确认合同、录入回款）？

**当前文档描述**：
- 管理角色：✅ 可以查看数据
- 管理角色：❌ 不能作为经办人推进客户（HQ/BRANCH）

**改进建议**：
- ✅ **明确规则**：
  1. 管理角色可以查看和编辑客户基础信息
  2. 管理角色可以修改经办人（分配/转交）
  3. 管理角色**不能**代替经办人推进客户（不能确认合同、录入回款等）
  4. 管理角色可以查看所有跟进记录、拜访记录等，但不能代替经办人创建

---

## 四、状态流转边界情况

### ❌ 问题7：直接从跟进到交案，跳过面谈状态

**问题描述**：
- 正常流程：跟进（空白）→ 跟进（面谈）→ 交案
- **问题**：如果客户直接从跟进状态确认合同，没有有效拜访记录（`valid_visit_count = 0`），状态如何变化？
  - `status`: `FOLLOW_UP` → `CASE` ✅
  - `sales_stage`: `BLANK` → `CASE` ✅（跳过 `MEETING`）
  - 这是否合理？是否需要强制要求至少一次有效拜访才能交案？

**当前设计**：
- 确认合同 → `status` 转为 `CASE`，`sales_stage` 同步为 `CASE`
- 没有强制要求必须经过面谈状态

**改进建议**：
- ✅ **方案1（推荐）**：允许跳过面谈，直接交案（业务灵活性）
- ✅ **方案2**：强制要求至少一次有效拜访才能交案（数据质量保证）

---

### ❌ 问题8：多次回款/律师费录入的状态变化

**问题描述**：
- 文档说："支持多笔回款记录"、"支持多笔律师费记录"
- **问题**：
  1. 第一笔回款：`CASE` → `PAYMENT` ✅
  2. 第二笔回款：状态是否保持 `PAYMENT`？还是重复变化？
  3. 第一笔律师费：`PAYMENT` → `WON` ✅
  4. 第二笔律师费：状态是否保持 `WON`？还是重复变化？

**当前设计**：
- 状态变化是单向的，不会重复变化
- 但文档没有明确说明多次录入的处理逻辑

**改进建议**：
- ✅ **明确规则**：
  1. 状态变化只在第一次录入时触发（`CASE` → `PAYMENT`，`PAYMENT` → `WON`）
  2. 后续录入只增加记录，不改变状态
  3. 状态一旦变为 `WON`，不能再回退

---

## 五、审批流程问题

### ❌ 问题9：审批链缺失层级的处理边界

**问题描述**：
- 文档说："若组织缺失某层级审批人，则自动跳过该层，进入上一级"
- **问题**：
  1. 如果所有层级都缺失审批人，会怎样？
  2. 如果 TEAM 层级缺失，SALES 申领时审批链如何构建？
  3. 如果 BRANCH 层级缺失，审批链如何构建？

**当前设计**：
```typescript
// 如果 TEAM 缺失，SALES 申领时审批链应该是？
return ['TEAM', 'BRANCH', 'HQ']  // ❌ TEAM 缺失时怎么办？
```

**改进建议**：
- ✅ **明确规则**：
  1. 如果某层级缺失，自动跳过该层，进入上一级
  2. 如果所有层级都缺失，则进入最高层级（HQ）
  3. 如果连 HQ 都缺失，则审批失败，需要人工处理

**改进后的代码逻辑**：
```typescript
export function buildApprovalChain(
  applicantRole: UserRoleLevel,
  availableRoles: UserRoleLevel[]  // 可用的审批人角色列表
): UserRoleLevel[] {
  const chain: UserRoleLevel[] = []

  if (applicantRole === 'HQ') {
    if (availableRoles.includes('HQ')) chain.push('HQ')
  } else if (applicantRole === 'BRANCH') {
    if (availableRoles.includes('BRANCH')) chain.push('BRANCH')
    if (availableRoles.includes('HQ')) chain.push('HQ')
  } else if (applicantRole === 'TEAM') {
    if (availableRoles.includes('BRANCH')) chain.push('BRANCH')
    if (availableRoles.includes('HQ')) chain.push('HQ')
  } else {  // SALES
    if (availableRoles.includes('TEAM')) chain.push('TEAM')
    if (availableRoles.includes('BRANCH')) chain.push('BRANCH')
    if (availableRoles.includes('HQ')) chain.push('HQ')
  }

  // 如果所有层级都缺失，至少要有 HQ
  if (chain.length === 0 && availableRoles.includes('HQ')) {
    chain.push('HQ')
  }

  return chain.length > 0 ? chain : ['HQ']  // 兜底：至少返回 HQ
}
```

---

### ❌ 问题10：审批驳回后的重新申请规则

**问题描述**：
- 文档说："任一层级驳回：保持原状态，记录 `reject_reason` + 审批历史，申请人可重新提交"
- **问题**：
  1. 重新提交时，是否需要修改申请内容？
  2. 重新提交时，审批链是否重新构建？
  3. 是否有重新提交的次数限制？

**改进建议**：
- ✅ **明确规则**：
  1. 重新提交时，可以修改申请内容（如转交原因、目标经办人等）
  2. 重新提交时，审批链重新构建（可能因为组织架构变化）
  3. 建议设置重新提交次数限制（如最多3次），超过后需要人工处理

---

## 六、数据范围问题

### ❌ 问题11：跨分所/跨团队的数据访问边界

**问题描述**：
- HQ 可以查看全所数据
- BRANCH 可以查看本分所数据
- TEAM 可以查看本团队数据
- **问题**：
  1. 如果客户转交给其他分所/团队的销售人员，原分所/团队的管理角色是否还能查看？
  2. 如果客户在分所A，但经办人在分所B，BRANCH-A 能否查看？

**改进建议**：
- ✅ **明确规则**：
  1. 数据范围按**客户所属组织**划分，不按经办人划分
  2. 如果客户转交给其他分所/团队，原分所/团队的管理角色仍可查看（基于客户所属组织）
  3. 如果客户所属组织变更，需要特殊审批（如 HQ 审批）

---

## 七、总结与优先级

### 🔴 高优先级问题（必须修复）

1. **问题1**：TEAM 申领公海客户需要自己审批自己 ❌
2. **问题2**：HQ/BRANCH 不能申领但审批链支持申领（矛盾）❌
3. **问题5**：客户转交后原经办人的数据访问权限不明确 ❌

### 🟡 中优先级问题（建议修复）

4. **问题3**：HQ/BRANCH 分配客户给自己的边界情况 ❌
5. **问题6**：管理角色查看他人客户数据的边界 ❌
6. **问题9**：审批链缺失层级的处理边界 ❌

### 🟢 低优先级问题（优化建议）

7. **问题4**：TEAM 双重职能的权限边界不清晰
8. **问题7**：直接从跟进到交案，跳过面谈状态
9. **问题8**：多次回款/律师费录入的状态变化
10. **问题10**：审批驳回后的重新申请规则
11. **问题11**：跨分所/跨团队的数据访问边界

---

## 八、改进建议汇总

### 1. 审批链优化

```typescript
// 改进后的审批链构建逻辑
export function buildApprovalChain(
  applicantRole: UserRoleLevel,
  availableRoles: UserRoleLevel[] = ['TEAM', 'BRANCH', 'HQ']
): UserRoleLevel[] {
  const chain: UserRoleLevel[] = []

  switch (applicantRole) {
    case 'HQ':
      // HQ 申领：自己审批即可
      if (availableRoles.includes('HQ')) chain.push('HQ')
      break

    case 'BRANCH':
      // BRANCH 申领：BRANCH → HQ（跳过自己）
      if (availableRoles.includes('BRANCH')) chain.push('BRANCH')
      if (availableRoles.includes('HQ')) chain.push('HQ')
      break

    case 'TEAM':
      // TEAM 申领：BRANCH → HQ（跳过自己）
      if (availableRoles.includes('BRANCH')) chain.push('BRANCH')
      if (availableRoles.includes('HQ')) chain.push('HQ')
      break

    case 'SALES':
      // SALES 申领：TEAM → BRANCH → HQ
      if (availableRoles.includes('TEAM')) chain.push('TEAM')
      if (availableRoles.includes('BRANCH')) chain.push('BRANCH')
      if (availableRoles.includes('HQ')) chain.push('HQ')
      break
  }

  // 兜底：至少要有 HQ
  if (chain.length === 0 && availableRoles.includes('HQ')) {
    chain.push('HQ')
  }

  return chain.length > 0 ? chain : ['HQ']
}
```

### 2. 权限控制优化

- ✅ 分配客户时，禁止 HQ/BRANCH 选择自己作为经办人
- ✅ 转交后，原经办人只能查看转交前的历史数据（只读）
- ✅ 管理角色可以查看和编辑客户基础信息，但不能代替经办人推进客户

### 3. 状态流转优化

- ✅ 允许跳过面谈状态，直接交案（业务灵活性）
- ✅ 状态变化只在第一次录入时触发，后续录入只增加记录

---

**文档版本**：v1.0
**最后更新**：2024-12-25
**维护人员**：系统开发团队

